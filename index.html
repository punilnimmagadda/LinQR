<html>
<head>
    <title>LinQR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="fontawesome-free-5.13.0-web/css/all.css">
    <link rel="stylesheet" href="styles/bootstrap-4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles/main.css">
    <script src="scripts/jquery-3.5.0.min.js"></script>
    <script src="scripts/bootstrap-4.3.1/js/bootstrap.min.js"></script>
    <script src="scripts/qrcode.min.js"></script>
</head>
<body>
    <header>
        <h1 class="app-title">LinQR</h1>
        <h5 class="app-sub-title">QR Code Generator</h3>
    </header>
    <main class="container">
        <div class="qr-wrapper">
            <div class="input-group mb-4">
                <input type="url" id="qrData" class="form-control" placeholder="Enter URL" aria-label="Enter URL" aria-describedby="basic-addon2">
                <div class="input-group-append">
                    <button id="generateQRCode" class="btn btn-primary" type="button">Generate QR Code</button>
                </div>
            </div>
            <div id="qrCode" class="mb-4"></div>
            <div class="qr-actions">
                <a href="#" id="downloadQRImage" class="btn btn-primary btn-sm" role="button">Download <i class="fas fa-download" style="display: inline;"></i></a>
                <button id="copyQRImageToClipboard" class="btn btn-primary btn-sm" type="button">Copy to Clipboard <i class="far fa-copy" style="display: inline;"></i></button>
            </div>
            <div id="qrCopyToast" class="toast" style="min-width: 300px; margin: 0 auto; position: absolute; bottom: 74px; left: 0; right: 0;" data-delay="5000">
                <div class="toast-header">
                    <strong class="mr-auto">Alert</strong>
                    <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="toast-body" style="text-align: center;">
                    Image copied to Clipboard!
                </div>
            </div>
        </div>
        <script>

            //bind event to generate QR Code on pressing ENTER
            $("#qrData").
                on("keydown", function (e) {
                    if (e.keyCode == 13) {
                        $('#qrCode').text('');
                        $("#qrCode, .qr-actions *").hide();
                        generateQRCode();
                    }
                });
            
            //bind event to generate QR Code on clicking "Generate QR Code" button
            $("#generateQRCode").
                on("click", function (e) {
                    $('#qrCode').text('');
                    $("#qrCode, .qr-actions *").hide();
                    generateQRCode();
                });

            //generates QR Code if URL is valid
            function generateQRCode () {      
                let elText = document.getElementById("qrData");

                if (!elText.value) {
                    //show alert if input field is empty
                    alert("Please enter URL.");
                    elText.focus();
                    return;
                } else {
                    //validate URL
                    let isURL = validateURL(elText.value);
                    if(isURL) {

                        //generate QR Code
                        let qrcode = new QRCode("qrCode", {
                            text: elText,
                            width: 200,
                            height: 200,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });

                        qrcode.makeCode(elText.value);

                        setTimeout(function(){ $("#downloadQRImage").attr("href", $('#qrCode img').attr('src')).attr("download", "download.png"); }, 300);

                        //show QR Code actions i.e., Download and Copy to Clipboard buttons 
                        $("#qrCode, .qr-actions *").show();
                    } else {
                        //show alert if URL is invalid
                        alert("Please enter a valid URL.");
                        elText.focus();
                        return;
                    }
                }
            }
            
            //bind event to copy QR Code as Image on clicking "Generate QR Code" button
            $("#copyQRImageToClipboard").
                on("click", function (e) {
                    try {
                        let pngImageBlob = dataURItoBlob($("#qrCode img").attr("src"));
                        navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': pngImageBlob
                            })
                        ]).then(
                            () => $('#qrCopyToast').toast('show')
                        );
                    } catch (error) {
                        console.error(error);
                    }
                });

            function dataURItoBlob(dataURI) {
                // convert base64 to raw binary data held in a string
                // doesn't handle URLEncoded DataURIs - see SO answer #6850276 for code that does this
                var byteString = atob(dataURI.split(',')[1]);

                // separate out the mime component
                var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]

                // write the bytes of the string to an ArrayBuffer
                var ab = new ArrayBuffer(byteString.length);

                // create a view into the buffer
                var ia = new Uint8Array(ab);

                // set the bytes of the buffer to the correct values
                for (var i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }

                // write the ArrayBuffer to a blob, and you're done
                var blob = new Blob([ab], {type: mimeString});
                return blob;
            }

            function validateURL(url) {
                var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
                    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
                    '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
                    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
                    '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
                    '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
                return !!pattern.test(url);
            }
        </script>
    </main>
    <footer>
        <div class="app-developed-by">Developed by <a id="sendEmail" href="mailto:punilnimmagadda@gmail.com?Subject=[From LinQR]" target="_top">Punil Nimmagadda</a></div>
    </footer>
</body>
</html>